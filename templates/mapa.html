{% extends "layouts/base.html" %}

{% block title %}Mapa de Cobertura · ATX Coverage{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/map.css') }}">
{% endblock %}

{% block content %}
<section class="map-wrapper">
    <aside class="map-panel" id="controlPanel">
        <header class="panel-header">
            <h2 class="panel-title">Planejamento Georreferenciado</h2>
            <p class="panel-subtitle">Ajuste parâmetros, visualize o enlace e acompanhe o perfil profissional.</p>
        </header>

        <div class="panel-card">
            <h3 class="card-title">Estação Transmissora</h3>
            <dl class="card-grid" id="txSummary">
                <div>
                    <dt>Latitude</dt>
                    <dd id="txLat">-</dd>
                </div>
                <div>
                    <dt>Longitude</dt>
                    <dd id="txLng">-</dd>
                </div>
                <div>
                    <dt>Frequência</dt>
                    <dd id="txFreq">-</dd>
                </div>
                <div>
                    <dt>Modelo</dt>
                    <dd id="txModel">-</dd>
                </div>
            </dl>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Cobertura</h3>
            <label class="form-label" for="radiusInput">Raio de análise (km)</label>
            <div class="input-group">
                <input type="range" id="radiusInput" min="5" max="150" step="5" value="30">
                <span class="input-value" id="radiusValue">30 km</span>
            </div>

            <div class="dual-input">
                <div>
                    <label class="form-label" for="minField">Min dBµV/m</label>
                    <input type="number" id="minField" placeholder="auto" step="0.1">
                </div>
                <div>
                    <label class="form-label" for="maxField">Max dBµV/m</label>
                    <input type="number" id="maxField" placeholder="auto" step="0.1">
                </div>
            </div>

            <button class="btn btn-brand w-100" id="btnGenerateCoverage">Gerar cobertura</button>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Visualização</h3>
            <p class="assist-text">Arraste o marcador vermelho para reposicionar a TX. A região circular acompanha o raio selecionado.</p>
            <div class="slider-row">
                <label class="form-label" for="overlayOpacity">Transparência</label>
                <input type="range" id="overlayOpacity" min="0.1" max="1" step="0.05">
                <span id="overlayOpacityValue">0.85</span>
            </div>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Ajuste de Tilt</h3>
            <label class="form-label" for="tiltControl">Tilt elétrico TX (°)</label>
            <div class="input-group">
                <input type="range" id="tiltControl" min="-10" max="30" step="0.5" value="0">
                <span class="input-value" id="tiltValue">0°</span>
            </div>
            <p class="assist-text">O ganho vertical é recalculado em E/Emax (θ = 0°) para o perfil de cobertura.</p>
        </div>

        <div class="panel-card">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Recepções</h3>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnClearRx">Limpar</button>
            </div>
            <p class="assist-text">Clique no mapa para adicionar pontos RX. Toque em um item para focar ou gerar perfil.</p>
            <ul class="rx-list" id="rxList"></ul>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Resumo de Ganho</h3>
            <dl class="card-grid" id="gainSummary">
                <div>
                    <dt>Ganho base</dt>
                    <dd id="gainBase">-</dd>
                </div>
                <div>
                    <dt>Horizontal (min/max)</dt>
                    <dd id="gainHorizontal">-</dd>
                </div>
                <div>
                    <dt>Vertical (θ=0)</dt>
                    <dd id="gainVertical">-</dd>
                </div>
                <div>
                    <dt>Escala</dt>
                    <dd id="fieldScale">-</dd>
                </div>
            </dl>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Perfil Profissional</h3>
            <p class="assist-text">Selecione um ponto RX no mapa para visualizar o perfil com Fresnel e curvatura.</p>
            <button class="btn btn-outline-primary w-100" id="btnGenerateProfile" disabled>Gerar perfil do enlace</button>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Ligação TX ↔ RX</h3>
            <dl class="card-grid" id="linkSummary">
                <div>
                    <dt>Distância</dt>
                    <dd id="linkDistance">-</dd>
                </div>
                <div>
                    <dt>Direção</dt>
                    <dd id="linkBearing">-</dd>
                </div>
                <div>
                    <dt>Campo estimado</dt>
                    <dd id="linkField">-</dd>
                </div>
                <div>
                    <dt>Terreno RX</dt>
                    <dd id="linkElevation">-</dd>
                </div>
            </dl>
        </div>

        <div class="colorbar-card" id="colorbarCard" hidden>
            <img id="colorbarImage" alt="Colorbar cobertura" />
        </div>
    </aside>

    <div class="map-canvas">
        <div id="coverageMap" class="map-container"></div>
        <div class="map-floating-card" id="mapTooltip" hidden></div>
    </div>
</section>

<!-- Modal Perfil -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Perfil de Enlace</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <img id="profileImage" alt="Perfil de enlace" class="profile-image" />
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="{{ url_for('static', filename='js/pages/mapa.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=geometry&callback=initCoverageMap" async defer></script>
{% endblock %}
